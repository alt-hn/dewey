---
import PageHead from '../../components/PageHead.astro';
import HeaderSection from '../../components/HeaderSection.astro';
import MainSection from '../../components/MainSection.astro';
import FooterSection from '../../components/FooterSection.astro';
import FooterAssets from '../../components/FooterAssets.astro';

import Navbar from '../pages/gioi-thieu/sections/Navbar.astro';
import HeroSlider from '../pages/gioi-thieu/sections/HeroSlider.astro';
import IntroSection from '../pages/gioi-thieu/sections/IntroSection.astro';
import ProgramCardsSection from '../pages/gioi-thieu/sections/ProgramCardsSection.astro';
import InfographicSection from '../pages/gioi-thieu/sections/InfographicSection.astro';
import LifeEduSection from '../pages/gioi-thieu/sections/LifeEduSection.astro';
import ExtracurricularSection from '../pages/gioi-thieu/sections/ExtracurricularSection.astro';
import CampusListSection from '../pages/gioi-thieu/sections/CampusListSection.astro';
import ThanhTichAltSection from '../pages/gioi-thieu/sections/ThanhTichAltSection.astro';
import ThanhTichGridSection from '../pages/gioi-thieu/sections/ThanhTichGridSection.astro';
import ThanhTichInfographicSection from '../pages/gioi-thieu/sections/ThanhTichInfographicSection.astro';

const url = new URL(Astro.request.url);

// Debug: log full URL and params
console.log('Full URL:', Astro.request.url);
console.log('Search params:', url.searchParams.toString());
console.log('header param raw:', url.searchParams.get('header'));
console.log('main param raw:', url.searchParams.get('main'));
console.log('footer param raw:', url.searchParams.get('footer'));

// Parse and clean component lists - handle trailing spaces and commas
const parseComponents = (param: string | null): string[] => {
  if (!param) return [];
  return param
    .split(',')
    .map(s => s.trim())
    .filter(s => s.length > 0);
};

const header = parseComponents(url.searchParams.get('header'));
const main = parseComponents(url.searchParams.get('main'));
const footer = parseComponents(url.searchParams.get('footer'));

console.log('Parsed header:', header);
console.log('Parsed main:', main);
console.log('Parsed footer:', footer);

const _embedParam = url.searchParams.get('embed');
// Default to embedded/lightweight mode for previews to avoid injecting
// the site's <base> url and loading production resources. Only disable
// embed when explicitly requested with embed=0 or embed=false.
const embed = _embedParam === null ? true : !(_embedParam === '0' || _embedParam === 'false');

// Determine if we have any components to render
const hasContent = header.length > 0 || main.length > 0 || footer.length > 0;

// Debug logging
console.log('Has content?', hasContent);

---

<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assembled Preview</title>
    {embed && (
      <style>
        :root { color-scheme: light; }
        body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
      </style>
    )}
    {!embed && <PageHead />}
  </head>
  <body>
    {hasContent ? (
      <>
        <!-- Header group -->
        {header.map(id => (
          (id === 'HeaderSection' && <HeaderSection />) ||
          (id === 'Navbar' && <Navbar />) ||
          null
        ))}

        <!-- Main group -->
        {main.map(id => (
          (id === 'MainSection' && <MainSection />) ||
          (id === 'HeroSlider' && <HeroSlider />) ||
          (id === 'IntroSection' && <IntroSection />) ||
          (id === 'ProgramCardsSection' && <ProgramCardsSection />) ||
          (id === 'InfographicSection' && <InfographicSection />) ||
          (id === 'LifeEduSection' && <LifeEduSection />) ||
          (id === 'ExtracurricularSection' && <ExtracurricularSection />) ||
          (id === 'CampusListSection' && <CampusListSection />) ||
          (id === 'ThanhTichAltSection' && <ThanhTichAltSection />) ||
          (id === 'ThanhTichGridSection' && <ThanhTichGridSection />) ||
          (id === 'ThanhTichInfographicSection' && <ThanhTichInfographicSection />) ||
          null
        ))}

        <!-- Footer group -->
        {footer.map(id => (
          (id === 'FooterSection' && <FooterSection />) ||
          (id === 'Footer' && <FooterSection />) ||
          (id === 'FooterAssets' && <FooterAssets />) ||
          null
        ))}
      </>
    ) : (
      <div style="padding: 40px; text-align: center; color: #666;">
        <p>No components selected. Use the storybook to select components.</p>
        <p style="font-size: 12px; color: #999;">Debug: header={header.length}, main={main.length}, footer={footer.length}</p>
      </div>
    )}
  </body>
</html>
