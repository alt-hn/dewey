---
import PageHead from '../../components/PageHead.astro';
// Import component data for validation
import componentsData from '../../data/components.json';
---

<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Assembled Preview</title>
    <style>
      :root { color-scheme: light; }
      body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
      #loading {
        padding: 40px;
        text-align: center;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <p>Loading components...</p>
    </div>
    <div id="content"></div>

    <script define:vars={{ componentsData }}>
      // Component data available from server
      const availableComponents = componentsData.components;

      // Helper function to validate components
      const validateComponents = (components, group) => {
        return components.filter(id => {
          const exists = availableComponents.some(comp => comp.id === id && comp.group === group);
          if (!exists) {
            console.warn(`Component '${id}' in group '${group}' not found in components.json`);
          }
          return exists;
        });
      };

      // Parse URL parameters
      const url = new URL(window.location.href);
      const parseComponents = (param) => {
        if (!param) return [];
        return decodeURIComponent(param)
          .split(',')
          .map(s => s.trim())
          .filter(s => s.length > 0);
      };

      const header = validateComponents(parseComponents(url.searchParams.get('header')), 'header');
      const main = validateComponents(parseComponents(url.searchParams.get('main')), 'main');
      const footer = validateComponents(parseComponents(url.searchParams.get('footer')), 'footer');
      
      const embedParam = url.searchParams.get('embed');
      const embed = embedParam === null ? true : !(embedParam === '0' || embedParam === 'false');

      console.log('Client-side parsing:');
      console.log('header:', header);
      console.log('main:', main);
      console.log('footer:', footer);

      const hasContent = header.length > 0 || main.length > 0 || footer.length > 0;

      const loadingDiv = document.getElementById('loading');
      const contentDiv = document.getElementById('content');

      if (!loadingDiv || !contentDiv) {
        console.error('Required DOM elements not found');
        return;
      }

      if (!hasContent) {
        loadingDiv.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #666;">
            <p>No components selected. Use the storybook to select components.</p>
            <p style="font-size: 12px; color: #999;">Debug: header=${header.length}, main=${main.length}, footer=${footer.length}</p>
          </div>
        `;
      } else {
        // Async function to load all components
        async function loadComponents() {
          const allComponents = [
            ...header.map(id => ({ group: 'header', id })),
            ...main.map(id => ({ group: 'main', id })),
            ...footer.map(id => ({ group: 'footer', id }))
          ];

          const loadedStylesheets = new Set();

          for (const { group, id } of allComponents) {
            try {
              const response = await fetch(`/previews/embed/${group}/${id}?embed=${embed ? '1' : '0'}`);
              const html = await response.text();
              
              // Extract content from the fetched HTML
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              
              // Load stylesheets from head (avoid duplicates)
              doc.head.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !loadedStylesheets.has(href)) {
                  loadedStylesheets.add(href);
                  const newLink = document.createElement('link');
                  newLink.rel = 'stylesheet';
                  newLink.href = href;
                  document.head.appendChild(newLink);
                }
              });
              
              // Also load stylesheets from body (Astro sometimes renders <link> tags in body)
              doc.body.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                const href = link.getAttribute('href');
                if (href && !loadedStylesheets.has(href)) {
                  loadedStylesheets.add(href);
                  const newLink = document.createElement('link');
                  newLink.rel = 'stylesheet';
                  newLink.href = href;
                  document.head.appendChild(newLink);
                }
              });
              
              // Load inline styles from head
              doc.head.querySelectorAll('style').forEach(style => {
                const newStyle = document.createElement('style');
                newStyle.textContent = style.textContent;
                document.head.appendChild(newStyle);
              });
              
              // Also load inline styles from body
              doc.body.querySelectorAll('style').forEach(style => {
                const newStyle = document.createElement('style');
                newStyle.textContent = style.textContent;
                document.head.appendChild(newStyle);
              });
              
              // Insert body content
              const wrapper = document.createElement('div');
              wrapper.innerHTML = doc.body.innerHTML;
              contentDiv.appendChild(wrapper);
              
              // Execute any scripts in the loaded content
              const scripts = wrapper.querySelectorAll('script');
              scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => {
                  newScript.setAttribute(attr.name, attr.value);
                });
                newScript.textContent = oldScript.textContent;
                if (oldScript.parentNode) {
                  oldScript.parentNode.replaceChild(newScript, oldScript);
                }
              });
              
            } catch (error) {
              console.error(`Failed to load ${group}/${id}:`, error);
              const errorDiv = document.createElement('div');
              errorDiv.style.cssText = 'padding: 20px; background: #fee; border: 1px solid #fcc; margin: 10px 0;';
              errorDiv.textContent = `Error loading ${group}/${id}`;
              contentDiv.appendChild(errorDiv);
            }
          }
          
          loadingDiv.remove();
        }

        loadComponents();
      }
    </script>
  </body>
</html>
