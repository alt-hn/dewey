---
// Section metadata with estimated heights at 1400px viewport width
// aspectRatio = height / width (1400px). Values > 1 mean section is taller than wide.
// Sections with aspectRatio > 1 will be capped and show a fade overlay
const sectionMeta: Record<string, { aspectRatio: number; note?: string }> = {
  // Header sections - typically short navigation bars
  'Navbar': { aspectRatio: 0.08, note: 'Compact navigation bar' },
  'HomeNavbar': { aspectRatio: 0.08, note: 'Home page navigation' },
  
  // Main sections - varying heights
  'HomeHeroSlider': { aspectRatio: 0.45, note: 'Hero carousel - 7 slides' },
  'HomeCertificationBadges': { aspectRatio: 0.3, note: 'CIS, AP, IB, Mount Vernon badges' },
  'HomeAboutSection': { aspectRatio: 0.4, note: 'Introduction image (desktop)' },
  'HomeFeaturesGrid': { aspectRatio: 0.9, note: 'Statistics + 12 feature cards' },
  'HomeStatisticsInfographic': { aspectRatio: 0.8, note: 'Mobile infographic (mobile only)' },
  'HomeCampusSlider': { aspectRatio: 0.35, note: '4 campus locations slider' },
  'HomeProgramCards': { aspectRatio: 0.55, note: '4 education program cards' },
  'HeroSlider': { aspectRatio: 0.45, note: 'Hero carousel' },
  'IntroSection': { aspectRatio: 0.5, note: 'Introduction block' },
  'ProgramCardsSection': { aspectRatio: 0.55, note: 'Program cards grid' },
  'InfographicSection': { aspectRatio: 0.7, note: 'Stats infographic' },
  'LifeEduSection': { aspectRatio: 0.25, note: 'Education quote section' },
  'ExtracurricularSection': { aspectRatio: 0.65, note: 'Extracurricular activities' },
  'CampusListSection': { aspectRatio: 0.35, note: 'Campus list' },
  'ThanhTichAltSection': { aspectRatio: 0.6, note: 'Achievements - alternative layout' },
  'ThanhTichGridSection': { aspectRatio: 0.55, note: 'Achievements grid' },
  'ThanhTichInfographicSection': { aspectRatio: 0.65, note: 'Achievements infographic' },
  'AchievementsPremiumSection': { aspectRatio: 0.85, note: 'Premium multi-layer achievements' },
  'GioiThieuSection': { aspectRatio: 0.6, note: 'Introduction section for Gioi Thieu' },
  
  // Footer sections
  'FooterAssets': { aspectRatio: 0.1, note: 'Footer scripts/assets - minimal visual' },
};

const headerOptions = [
  { id: 'HomeNavbar', label: 'HomeNavbar (New)' },
  { id: 'Navbar', label: 'Navbar (Gioi Thieu)' },
];

const mainOptions = [
  { id: 'HomeHeroSlider', label: 'HomeHeroSlider (New - 7 slides)' },
  { id: 'HomeCertificationBadges', label: 'HomeCertificationBadges (New)' },
  { id: 'HomeAboutSection', label: 'HomeAboutSection (New)' },
  { id: 'HomeFeaturesGrid', label: 'HomeFeaturesGrid (New - 12 cards)' },
  { id: 'HomeStatisticsInfographic', label: 'HomeStatisticsInfographic (New - Mobile)' },
  { id: 'HomeCampusSlider', label: 'HomeCampusSlider (New - 4 campuses)' },
  { id: 'HomeProgramCards', label: 'HomeProgramCards (New - 4 programs)' },
  { id: 'HeroSlider', label: 'HeroSlider (Gioi Thieu)' },
  { id: 'IntroSection', label: 'IntroSection (Gioi Thieu)' },
  { id: 'ProgramCardsSection', label: 'ProgramCardsSection (Gioi Thieu)' },
  { id: 'InfographicSection', label: 'InfographicSection (Gioi Thieu)' },
  { id: 'LifeEduSection', label: 'LifeEduSection (Gioi Thieu)' },
  { id: 'ExtracurricularSection', label: 'ExtracurricularSection (Gioi Thieu)' },
  { id: 'CampusListSection', label: 'CampusListSection (Gioi Thieu)' },
  { id: 'ThanhTichAltSection', label: 'ThanhTichAltSection (Gioi Thieu)' },
  { id: 'ThanhTichGridSection', label: 'ThanhTichGridSection (Gioi Thieu)' },
  { id: 'ThanhTichInfographicSection', label: 'ThanhTichInfographicSection (Gioi Thieu)' },
  { id: 'AchievementsPremiumSection', label: 'AchievementsPremiumSection (Premium)' },
  { id: 'GioiThieuSection', label: 'GioiThieuSection (Gioi Thieu)' },
];

const footerOptions = [
  { id: 'FooterAssets', label: 'FooterAssets' },
];

---

<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dewey Storybook - Component Library</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root { 
        --accent: #0ea5ff; 
        --accent-hover: #0c8fe0;
        --accent-light: #e6f7ff;
        --muted: #6b7280; 
        --card-bg: #ffffff; 
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --border: #e5e7eb;
        --bg-primary: #f9fafb;
        --bg-secondary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      
      * { box-sizing: border-box; }
      
      body { 
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; 
        margin: 0;
        padding: 24px; 
        color: var(--text-primary); 
        background: var(--bg-primary);
        line-height: 1.5;
      }
      
      .header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        gap: 16px; 
        max-width: 1400px; 
        margin: 0 auto 24px;
        padding: 20px 24px;
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }
      
      .title { 
        font-size: 24px; 
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent) 0%, #0c8fe0 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .subtitle { 
        color: var(--text-secondary); 
        font-size: 14px;
        margin-top: 4px;
      }
      
      .controls { 
        display: flex; 
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .btn { 
        padding: 10px 16px; 
        border-radius: 10px; 
        border: 1px solid var(--border); 
        background: var(--card-bg); 
        cursor: pointer; 
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
      }
      
      .btn:hover { 
        background: var(--bg-secondary);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .btn.primary { 
        background: var(--accent); 
        color: #fff; 
        border: none;
      }
      
      .btn.primary:hover {
        background: var(--accent-hover);
      }
      
      .btn.success {
        background: var(--success);
        color: #fff;
        border: none;
      }
      
      .btn.success:hover {
        background: #059669;
      }
      
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .layout { 
        max-width: 1400px; 
        margin: 0 auto; 
      }

      .stats {
        display: flex;
        gap: 16px;
        padding: 16px 24px;
        background: var(--card-bg);
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border);
      }
      
      .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .stat-label {
        color: var(--text-secondary);
        font-size: 13px;
      }
      
      .stat-value {
        font-weight: 700;
        font-size: 18px;
        color: var(--accent);
      }

      .grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px;
        margin-bottom: 24px;
        height: 600px;
      }
      
      .group { 
        background: var(--card-bg); 
        padding: 20px; 
        border-radius: 16px; 
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        transition: box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .group:hover {
        box-shadow: var(--shadow-lg);
      }
      
      .group h3 { 
        margin: 0 0 16px 0; 
        font-size: 16px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--bg-secondary);
        flex-shrink: 0;
      }
      
      .group-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      .group-badge {
        font-size: 12px;
        padding: 2px 8px;
        background: var(--accent-light);
        color: var(--accent);
        border-radius: 12px;
        font-weight: 600;
      }

      .card { 
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
        margin-bottom: 16px;
        padding: 12px;
        background: var(--bg-primary);
        border-radius: 12px;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }
      
      .card:hover {
        background: #fff;
        box-shadow: var(--shadow-md);
      }
      
      .card-visual { 
        position: relative; 
        /* Height is set dynamically based on section aspect ratio */
        min-height: 60px;
        overflow: hidden; 
        border-radius: 10px; 
        border: 2px solid var(--border); 
        background: #fff;
        transition: border-color 0.2s ease, height 0.3s ease;
        flex-shrink: 0;
      }
      
      /* Fade overlay for sections that overflow (taller than 1:1) */
      .card-visual.has-overflow::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: linear-gradient(to bottom, 
          rgba(255,255,255,0) 0%, 
          rgba(255,255,255,0.7) 40%,
          rgba(255,255,255,0.95) 80%, 
          rgba(255,255,255,1) 100%
        );
        pointer-events: none;
        z-index: 10;
      }
      
      /* "More content below" indicator */
      .card-visual.has-overflow::before {
        content: '‚ãØ';
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        color: var(--text-secondary);
        z-index: 11;
        letter-spacing: 4px;
      }
      
      .card-visual:hover {
        border-color: var(--accent);
      }
      
      .card-visual.selected {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
      }
      
      .card-visual iframe { 
        width: 100%; 
        height: 100%; 
        border: 0; 
        pointer-events: none; 
        display: block;
      }
      
      .card-meta { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        gap: 8px;
      }
      
      .label { 
        font-size: 14px; 
        font-weight: 600;
        color: var(--text-primary);
      }
      
      .muted { 
        color: var(--text-secondary); 
        font-size: 13px;
      }

      .overlay { 
        position: absolute; 
        right: 12px; 
        top: 12px;
        background: rgba(255, 255, 255, 0.98); 
        padding: 8px; 
        border-radius: 8px; 
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border);
      }
      
      .overlay input[type=checkbox] { 
        width: 20px; 
        height: 20px;
        cursor: pointer;
        accent-color: var(--accent);
      }

      .card-actions { 
        display: flex; 
        gap: 6px;
      }
      
      .small { 
        padding: 6px 12px; 
        border-radius: 8px; 
        font-weight: 600;
        font-size: 13px;
        border: 1px solid var(--border);
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .small:hover {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }
      
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      
      .section-title {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .section-actions {
        display: flex;
        gap: 8px;
      }

      #selectedViewport { 
        width: 100%; 
        min-height: 200px;
        background: var(--bg-primary); 
        border: 2px dashed var(--border); 
        border-radius: 12px; 
        overflow-y: auto;
        transition: all 0.2s ease;
      }
      
      #selectedViewport:empty::before {
        content: 'Ch·ªçn components t·ª´ th∆∞ vi·ªán b√™n tr√™n...';
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-secondary);
        font-size: 14px;
      }
      
      #selectedViewport:not(:empty) {
        border-style: solid;
        background: #fff;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
      }
      
      .selected-item {
        transition: all 0.2s ease;
        line-height: 0;
        margin: 0;
        padding: 0;
      }
      
      .selected-item iframe {
        vertical-align: bottom;
      }
      
      .selected-item:not(:last-child) {
        border-bottom: 2px solid var(--border);
      }

      .assembled-preview { 
        margin-top: 24px; 
        height: 800px; 
        border: 0; 
        width: 100%; 
        border-radius: 12px; 
        overflow: hidden;
        box-shadow: var(--shadow-xl);
        border: 2px solid var(--border);
        display: none;
      }
      
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 20px;
        background: var(--text-primary);
        color: #fff;
        border-radius: 12px;
        box-shadow: var(--shadow-xl);
        font-weight: 600;
        font-size: 14px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .toast.success {
        background: var(--success);
      }
      
      .toast.error {
        background: var(--danger);
      }
      
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @media (max-width: 1200px) { 
        .grid { grid-template-columns: repeat(2, 1fr); }
        .header { flex-direction: column; align-items: flex-start; }
        .stats { flex-wrap: wrap; }
      }
      
      @media (max-width: 768px) { 
        .grid { grid-template-columns: 1fr; }
        body { padding: 16px; }
        .controls { width: 100%; }
        .btn { flex: 1; justify-content: center; }
      }
    </style>
    <style>
      #dev-toolbar-root { display: none !important; }
      astro-dev-toolbar { display: none !important; }
    </style>
  </head>
  <body>
    <div class="header layout">
      <div>
        <div class="title">üé® Dewey Storybook</div>
        <div class="subtitle">Component library & page builder</div>
      </div>
      <div class="controls">
        <button id="previewSelected" class="btn primary">
          <span>‚ñ∂</span> Preview Selected
        </button>
        <button id="selectAll" class="btn">
          <span>‚òë</span> Select All
        </button>
        <button id="clearSelection" class="btn">
          <span>‚úï</span> Clear
        </button>
        <button id="saveBtn" class="btn success">
          <span>üíæ</span> Save
        </button>
      </div>
    </div>

    <main class="layout">
      <div class="stats layout">
        <div class="stat-item">
          <span class="stat-label">Header:</span>
          <span class="stat-value">{headerOptions.length}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Main:</span>
          <span class="stat-value">{mainOptions.length}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Footer:</span>
          <span class="stat-value">{footerOptions.length}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total:</span>
          <span class="stat-value">{headerOptions.length + mainOptions.length + footerOptions.length}</span>
        </div>
        <div class="stat-item" style="margin-left: auto;">
          <span class="stat-label">Selected:</span>
          <span class="stat-value" id="selectedCount">0</span>
        </div>
      </div>
      <div class="grid">
        <div class="group">
          <h3>
            Header
            <span class="group-badge">{headerOptions.length}</span>
          </h3>
          <div class="group-content">
          {headerOptions.map(opt => (
            <div class="card">
              <div class="card-visual" data-component-id={opt.id} data-aspect-ratio={sectionMeta[opt.id]?.aspectRatio || 0.5}>
                <iframe src={`/previews/embed/header/${opt.id}`} loading="lazy" sandbox="allow-scripts" title={`${opt.id} preview`} referrerpolicy="no-referrer"></iframe>
                <div class="overlay"><input type="checkbox" name="header" value={opt.id} aria-label={`select ${opt.label}`} /></div>
              </div>
              <div class="card-meta">
                <div class="label">{opt.label}</div>
                <div class="card-actions">
                  <button class="small btn" data-group="header" data-id={opt.id} type="button">üëÅ Preview</button>
                </div>
              </div>
            </div>
          ))}
          </div>
        </div>

        <div class="group">
          <h3>
            Main
            <span class="group-badge">{mainOptions.length}</span>
          </h3>
          <div class="group-content">
          {mainOptions.map(opt => (
            <div class="card">
              <div class="card-visual" data-component-id={opt.id} data-aspect-ratio={sectionMeta[opt.id]?.aspectRatio || 0.5}>
                <iframe src={`/previews/embed/main/${opt.id}`} loading="lazy" sandbox="allow-scripts" title={`${opt.id} preview`} referrerpolicy="no-referrer"></iframe>
                <div class="overlay"><input type="checkbox" name="main" value={opt.id} aria-label={`select ${opt.label}`} /></div>
              </div>
              <div class="card-meta">
                <div class="label">{opt.label}</div>
                <div class="card-actions">
                  <button class="small btn" data-group="main" data-id={opt.id} type="button">üëÅ Preview</button>
                </div>
              </div>
            </div>
          ))}
          </div>
        </div>

        <div class="group">
          <h3>
            Footer
            <span class="group-badge">{footerOptions.length}</span>
          </h3>
          <div class="group-content">
          {footerOptions.map(opt => (
            <div class="card">
              <div class="card-visual" data-component-id={opt.id} data-aspect-ratio={sectionMeta[opt.id]?.aspectRatio || 0.5}>
                <iframe src={`/previews/embed/footer/${opt.id}`} loading="lazy" sandbox="allow-scripts" title={`${opt.id} preview`} referrerpolicy="no-referrer"></iframe>
                <div class="overlay"><input type="checkbox" name="footer" value={opt.id} aria-label={`select ${opt.label}`} /></div>
              </div>
              <div class="card-meta">
                <div class="label">{opt.label}</div>
                <div class="card-actions">
                  <button class="small btn" data-group="footer" data-id={opt.id} type="button">üëÅ Preview</button>
                </div>
              </div>
            </div>
          ))}
          </div>
        </div>
      </div>

      <section class="section">
        <div class="section-header">
          <h3 class="section-title">
            üì¶ Selected Components
            <span class="group-badge" id="selectedBadge">0</span>
          </h3>
          <div class="section-actions">
            <button id="openSelectedInNew" class="btn small">‚Üó Open in New Tab</button>
            <button id="clearSelected" class="btn small">Clear Selected</button>
          </div>
        </div>
        <div id="selectedViewport"></div>
      </section>
    </main>

    <script>
      // TypeScript-style type declarations for better IDE support
      interface Selection {
        header: string[];
        main: string[];
        footer: string[];
        order: string[];
      }

      // selection order is preserved here
      let selectionOrder: string[] = [];

      function updateStats(): void {
        const count = selectionOrder.length;
        const countEl = document.getElementById('selectedCount');
        const badgeEl = document.getElementById('selectedBadge');
        if (countEl) countEl.textContent = String(count);
        if (badgeEl) badgeEl.textContent = String(count);
      }

      function showToast(message: string, type: 'success' | 'error' = 'success'): void {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'slideIn 0.3s ease reverse';
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function getChecked(formName: string): string[] {
        const nodes = Array.from(document.querySelectorAll(`input[name="${formName}"]:checked`));
        return nodes.map(n => (n instanceof HTMLInputElement ? n.value : '')).filter(Boolean);
      }

      function updateCardVisuals(): void {
        // Highlight selected cards
        document.querySelectorAll('.card-visual').forEach(el => {
          if (!(el instanceof HTMLElement)) return;
          const componentId = el.dataset.componentId;
          if (componentId && selectionOrder.includes(componentId)) {
            el.classList.add('selected');
          } else {
            el.classList.remove('selected');
          }
        });
      }

      function addToOrder(id: string): void {
        if (!selectionOrder.includes(id)) selectionOrder.push(id);
        renderSelectedList();
        updateStats();
        updateCardVisuals();
      }

      function removeFromOrder(id: string): void {
        selectionOrder = selectionOrder.filter(x => x !== id);
        renderSelectedList();
        updateStats();
        updateCardVisuals();
      }

      function moveInOrder(id: string, dir: number): void {
        const i = selectionOrder.indexOf(id);
        if (i === -1) return;
        const j = i + dir;
        if (j < 0 || j >= selectionOrder.length) return;
        const tmp = selectionOrder[i];
        selectionOrder[i] = selectionOrder[j];
        selectionOrder[j] = tmp;
        renderSelectedList();
      }

      function renderSelectedList(): void {
        const container = document.getElementById('selectedViewport');
        if (!container) return;
        
        if (selectionOrder.length === 0) {
          container.innerHTML = '';
          return;
        }
        
        container.innerHTML = '';
        
        // Group selections by header, main, footer and maintain order within each group
        const headerItems: string[] = [];
        const mainItems: string[] = [];
        const footerItems: string[] = [];
        
        selectionOrder.forEach(id => {
          const group = groupForId(id);
          if (group === 'header') headerItems.push(id);
          else if (group === 'main') mainItems.push(id);
          else footerItems.push(id);
        });
        
        // Render in order: header -> main -> footer
        const orderedItems = [...headerItems, ...mainItems, ...footerItems];
        
        orderedItems.forEach((id, idx) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'selected-item';
          wrapper.dataset.id = id;
          wrapper.style.lineHeight = '0';

          const iframe = document.createElement('iframe');
          iframe.src = `/previews/embed/${groupForId(id)}/${id}?embed=1`;
          iframe.loading = 'eager';
          iframe.style.width = '100%';
          iframe.style.border = '0';
          iframe.style.display = 'block';
          iframe.style.margin = '0';
          iframe.style.padding = '0';
          // No sandbox for Selected Components - allow full asset loading
          iframe.style.pointerEvents = 'none';
          iframe.style.overflow = 'hidden';
          iframe.scrolling = 'no';
          
          // Set initial height to prevent layout shift
          iframe.style.height = '100px';
          
          // Listen for iframe load to adjust height
          iframe.addEventListener('load', () => {
            try {
              const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
              if (iframeDoc) {
                // Hide Astro dev toolbar in iframe
                const style = iframeDoc.createElement('style');
                style.textContent = `
                  astro-dev-toolbar { display: none !important; }
                  #dev-toolbar-root { display: none !important; }
                `;
                iframeDoc.head?.appendChild(style);
                
                // Force recalculation
                const body = iframeDoc.body;
                const html = iframeDoc.documentElement;
                
                const height = Math.max(
                  body?.scrollHeight || 0,
                  body?.offsetHeight || 0,
                  html?.clientHeight || 0,
                  html?.scrollHeight || 0,
                  html?.offsetHeight || 0
                );
                
                iframe.style.height = height + 'px';
                wrapper.style.height = height + 'px';
              }
            } catch (e) {
              // CORS restriction, use ResizeObserver fallback or default
              iframe.style.height = '600px';
              wrapper.style.height = '600px';
            }
          });

          wrapper.appendChild(iframe);
          container.appendChild(wrapper);
        });
      }

      function groupForId(id: string): string {
        if (document.querySelector(`input[name=header][value="${id}"]`)) return 'header';
        if (document.querySelector(`input[name=main][value="${id}"]`)) return 'main';
        return 'footer';
      }

      function buildAssembledUrl(): string {
        // Group by header, main, footer and preserve order within each group
        const headerItems: string[] = [];
        const mainItems: string[] = [];
        const footerItems: string[] = [];
        
        selectionOrder.forEach(id => {
          const group = groupForId(id);
          if (group === 'header') headerItems.push(id);
          else if (group === 'main') mainItems.push(id);
          else footerItems.push(id);
        });
        
        const params = new URLSearchParams();
        if (headerItems.length) params.set('header', headerItems.join(','));
        if (mainItems.length) params.set('main', mainItems.join(','));
        if (footerItems.length) params.set('footer', footerItems.join(','));
        // Remove order param as it's now implicit in the group ordering
        return '/previews/assembled' + (params.toString() ? ('?' + params.toString()) : '');
      }

      // scale iframe elements so their internal viewport behaves like a 1400px desktop
      // and adjust container height based on predefined aspect ratios
      function ensureDesktopIframes(): void {
        const DESKTOP_W = 1400;
        const MAX_ASPECT_RATIO = 1; // Maximum aspect ratio before showing overflow indicator
        const MAX_CONTAINER_HEIGHT = 280; // Maximum container height for overflow sections
        const MIN_CONTAINER_HEIGHT = 60; // Minimum container height

        function scaleIframe(iframeEl: HTMLIFrameElement | null): void {
          if (!iframeEl) return;
          
          const container = iframeEl.parentElement instanceof HTMLElement ? iframeEl.parentElement : iframeEl.parentNode as HTMLElement | null;
          
          // Only scale thumbnails in card-visual, not selected items
          if (container && container instanceof HTMLElement && container.classList.contains('card-visual')) {
            const containerWidth = (container && container.clientWidth) ? container.clientWidth : 300;
            const scale = Math.max(0.2, Math.min(1, containerWidth / DESKTOP_W));
            
            // Get aspect ratio from data attribute (predefined value)
            const aspectRatio = parseFloat(container.dataset.aspectRatio || '0.5');
            
            // Calculate the content height based on aspect ratio
            const contentHeight = DESKTOP_W * aspectRatio;
            
            // Calculate the scaled height that would be visible in the container
            const scaledHeight = contentHeight * scale;
            
            // Determine container height based on whether aspect ratio exceeds 1:1
            let targetContainerHeight: number;
            if (aspectRatio <= MAX_ASPECT_RATIO) {
              // Section fits within 1:1 ratio, use proportional height
              targetContainerHeight = Math.max(MIN_CONTAINER_HEIGHT, scaledHeight);
              container.classList.remove('has-overflow');
            } else {
              // Section exceeds 1:1 ratio, cap at max height and show overflow indicator
              targetContainerHeight = MAX_CONTAINER_HEIGHT;
              container.classList.add('has-overflow');
            }
            
            // Apply styles
            iframeEl.style.width = DESKTOP_W + 'px';
            iframeEl.style.height = contentHeight + 'px';
            iframeEl.style.transformOrigin = 'top center';
            container.style.position = 'relative';
            container.style.overflow = 'hidden';
            container.style.height = targetContainerHeight + 'px';
            iframeEl.style.position = 'absolute';
            iframeEl.style.left = '50%';
            iframeEl.style.top = '0';
            iframeEl.style.transform = `translateX(-50%) scale(${scale})`;
          }
        }

        document.querySelectorAll('.card-visual iframe').forEach((f) => scaleIframe(f as HTMLIFrameElement));
      }

      window.addEventListener('resize', () => {
        ensureDesktopIframes();
      });

      // per-card preview button
      document.addEventListener('click', (e) => {
        const btn = (e.target as HTMLElement).closest('button[data-group]') as HTMLButtonElement | null;
        if (!btn) return;
        const group = btn.dataset.group;
        const id = btn.dataset.id;
        if (!group || !id) return;
        const url = `/previews/assembled?${group}=${id}`;
        console.log('Opening preview URL:', url);
        window.open(url, '_blank');
      });

      // track checkbox selection order
      document.addEventListener('change', (e) => {
        const cb = (e.target as HTMLElement).closest('input[type="checkbox"]') as HTMLInputElement | null;
        if (!cb) return;
        const id = cb.value;
        if (cb.checked) addToOrder(id); else removeFromOrder(id);
      });

      // controls
      const previewSelectedBtn = document.getElementById('previewSelected') as HTMLButtonElement | null;
      const selectAllBtn = document.getElementById('selectAll') as HTMLButtonElement | null;
      const clearBtn = document.getElementById('clearSelection') as HTMLButtonElement | null;
      const clearSelectedBtn = document.getElementById('clearSelected') as HTMLButtonElement | null;
      const openSelectedInNewBtn = document.getElementById('openSelectedInNew') as HTMLButtonElement | null;
      const saveBtn = document.getElementById('saveBtn') as HTMLButtonElement | null;

      if (previewSelectedBtn) previewSelectedBtn.addEventListener('click', () => {
        const url = buildAssembledUrl();
        console.log('Opening preview URL:', url);
        window.open(url, '_blank');
        showToast('Opening preview in new tab...');
      });

      if (selectAllBtn) selectAllBtn.addEventListener('click', () => {
        selectionOrder = [];
        ['header','main','footer'].forEach(g => {
          document.querySelectorAll(`input[name="${g}"]`).forEach(n => { 
            if (n instanceof HTMLInputElement) { 
              n.checked = true; 
              selectionOrder.push(n.value); 
            } 
          });
        });
        renderSelectedList();
        updateStats();
        updateCardVisuals();
        showToast('All components selected!');
      });

      if (clearBtn) clearBtn.addEventListener('click', () => {
        document.querySelectorAll('input[type=checkbox]').forEach(n => { 
          if (n instanceof HTMLInputElement) n.checked = false; 
        });
        selectionOrder = [];
        renderSelectedList();
        updateStats();
        updateCardVisuals();
        showToast('Selection cleared!');
      });

      if (clearSelectedBtn) clearSelectedBtn.addEventListener('click', () => {
        document.querySelectorAll('input[type=checkbox]').forEach(n => { 
          if (n instanceof HTMLInputElement) n.checked = false; 
        });
        selectionOrder = [];
        renderSelectedList();
        updateStats();
        updateCardVisuals();
        showToast('Selection cleared!');
      });

      if (openSelectedInNewBtn) openSelectedInNewBtn.addEventListener('click', () => {
        const url = buildAssembledUrl();
        console.log('Opening URL:', url);
        window.open(url, '_blank');
      });

      if (saveBtn) saveBtn.addEventListener('click', async () => {
        const body: Selection = { 
          header: getChecked('header'), 
          main: getChecked('main'), 
          footer: getChecked('footer'), 
          order: selectionOrder 
        };
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'üíæ Saving...';
        
        try {
          const res = await fetch('/api/save-selection', { 
            method: 'POST', 
            headers: { 'content-type': 'application/json' }, 
            body: JSON.stringify(body) 
          });
          
          const ct = res.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
            const text = await res.text();
            if (!text) {
              showToast('Save failed: empty response', 'error');
            } else {
              try {
                const json = JSON.parse(text);
                if (json.ok) {
                  showToast('‚úì Saved to public/selection.json', 'success');
                } else {
                  showToast('Save failed: ' + (json.error ?? 'Unknown error'), 'error');
                }
              } catch (parseErr) {
                showToast('Save failed: invalid JSON', 'error');
              }
            }
          } else {
            const text = await res.text();
            showToast('Save failed: ' + text.slice(0, 100), 'error');
          }
        } catch (err) { 
          showToast('Save error: ' + String(err), 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<span>üíæ</span> Save';
        }
      });

      // load saved selection
      async function loadSaved(): Promise<void> {
        try {
          const res = await fetch('/selection.json');
          if (!res.ok) return;
          const sel: Selection = await res.json();
          if (!sel) return;
          
          (sel.header || []).forEach((id: string) => { 
            const el = document.querySelector(`input[name="header"][value="${id}"]`); 
            if (el instanceof HTMLInputElement) el.checked = true; 
          });
          (sel.main || []).forEach((id: string) => { 
            const el = document.querySelector(`input[name="main"][value="${id}"]`); 
            if (el instanceof HTMLInputElement) el.checked = true; 
          });
          (sel.footer || []).forEach((id: string) => { 
            const el = document.querySelector(`input[name="footer"][value="${id}"]`); 
            if (el instanceof HTMLInputElement) el.checked = true; 
          });
          
          if (Array.isArray(sel.order) && sel.order.length) {
            selectionOrder = sel.order.slice();
          } else {
            selectionOrder = [];
            ['header','main','footer'].forEach(g => {
              document.querySelectorAll(`input[name="${g}"]:checked`).forEach(n => { 
                if (n instanceof HTMLInputElement) selectionOrder.push(n.value); 
              });
            });
          }
          
          renderSelectedList();
          updateStats();
          updateCardVisuals();
        } catch (e) { /* ignore */ }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadSaved);
      } else {
        loadSaved();
      }

      // Initialize iframe scaling after load and attach load listeners for dynamic height
      function initIframeScaling(): void {
        document.querySelectorAll('.card-visual iframe').forEach((iframe) => {
          if (!(iframe instanceof HTMLIFrameElement)) return;
          
          // Initial scaling
          setTimeout(() => ensureDesktopIframes(), 100);
          
          // Re-scale when iframe content loads
          iframe.addEventListener('load', () => {
            setTimeout(() => ensureDesktopIframes(), 50);
          });
        });
        
        // Also run after a delay to catch lazy-loaded content
        setTimeout(() => ensureDesktopIframes(), 500);
        setTimeout(() => ensureDesktopIframes(), 1500);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initIframeScaling);
      } else {
        initIframeScaling();
      }
    </script>
  </body>
</html>
